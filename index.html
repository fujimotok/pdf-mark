<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer with Markdown Notes</title>
    <link rel="stylesheet" href="styles.css">
    <!-- SimpleMDE CSS CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
  </head>
  <body>
    <div id="container">
      <div id="pdf-load">
        <input type="file" id="file-input" accept="application/pdf">
      </div>
      <div id="pdf-viewer"></div>
      <div id="pdf-controls">
        <button id="prev-page">前のページ</button>
        <span id="page-num"></span> / <span id="page-count"></span>
        <button id="next-page">次のページ</button>
      </div>
      <textarea id="markdown-editor"></textarea>
    </div>

    <!-- PDF.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js"></script>
    
    <!-- SimpleMDE JS CDN -->
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    
    <script>
      let pdfDoc = null,
          pageNum = 1,
          pageRendering = false,
          pageNumPending = null,
          scale = 1.5,
          canvas = document.createElement('canvas'),
          ctx = canvas.getContext('2d');

      document.getElementById('pdf-viewer').appendChild(canvas);

      // SimpleMDEの設定
      const simplemde = new SimpleMDE({
        element: document.getElementById("markdown-editor"),
        placeholder: "Memo",
        spellChecker: false,
        status: false
      });

      // ファイルが選択されたときの処理
      document.getElementById('file-input').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file && file.type === 'application/pdf') {
          const reader = new FileReader();
          reader.onload = function(e) {
            const uint8Array = new Uint8Array(e.target.result);

            // PDF.jsを使ってPDFを表示
            pdfjsLib.getDocument(uint8Array).promise.then(pdf => {
              pdfDoc = pdf;
              document.getElementById('page-count').textContent = pdfDoc.numPages;
              renderPage(pageNum);
            });
          };
          reader.readAsArrayBuffer(file);
        }
      });

      // ページを表示する関数
      function renderPage(num) {
        pageRendering = true;
        pdfDoc.getPage(num).then(function(page) {
          const viewport = page.getViewport({ scale: scale });
          canvas.height = viewport.height;
          canvas.width = viewport.width;

          const renderContext = {
            canvasContext: ctx,
            viewport: viewport
          };
          const renderTask = page.render(renderContext);

          renderTask.promise.then(function() {
            pageRendering = false;
            if (pageNumPending !== null) {
              renderPage(pageNumPending);
              pageNumPending = null;
            }
          });
        });

        document.getElementById('page-num').textContent = num;
      }

      // ページ送りボタンのイベントリスナー
      document.getElementById('prev-page').addEventListener('click', function() {
        if (pageNum <= 1) {
          return;
        }
        pageNum--;
        renderPage(pageNum);
      });

      document.getElementById('next-page').addEventListener('click', function() {
        if (pageNum >= pdfDoc.numPages) {
          return;
        }
        pageNum++;
        renderPage(pageNum);
      });

    </script>
  </body>
</html>
